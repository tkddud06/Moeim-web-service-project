<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title th:text="${group.title} + ' | ÏÜåÎ™®ÏûÑ Ìôà'">ÏÜåÎ™®ÏûÑ Ìôà</title>
    <link rel="stylesheet" th:href="@{/css/group/group_home.css}">
</head>

<body>
<th:block layout:fragment="content">
<div class="home-back-ground">
    <div class="group-home-wrapper">


        <!--  ÏÉÅÎã® Î∞∞ÎÑà -->
        <div class="group-banner-top">
            <img th:if="${group.bannerImage != null}"
                 th:src="@{|/group/banner/${group.id}|}"
                 alt="Î∞∞ÎÑà Ïù¥ÎØ∏ÏßÄ">
        </div>

        <!-- ÏÉÅÎã® Ï†ïÎ≥¥ Î∞ïÏä§ -->
        <div class="banner-box">
            <div class="banner-text-section">
                <h1 class="group-title" th:text="${group.title}">Î™®ÏûÑ Ï†úÎ™©</h1>
                <p class="group-desc" th:text="${group.description}">Î™®ÏûÑ ÏÑ§Î™Ö</p>

                <div class="info-line">
                    <span th:text="'Ïπ¥ÌÖåÍ≥†Î¶¨ : ' + ${group.category.title}">Ïπ¥ÌÖåÍ≥†Î¶¨</span>
                    <span th:text="'Ïù∏Ïõê : ' + ${group.nowCount} + ' / ' + ${group.maxCount}">Ïù∏Ïõê</span>
                </div>
            </div>
        </div>

        <!-- ÏïÑÎûò 2Í∞ú Î∞ïÏä§ (Î©§Î≤Ñ / ÏùºÏ†ï) -->
        <div class="content-area">

            <!-- Î©§Î≤Ñ Î∞ïÏä§ -->
            <div class="box">
                <div class="box-header">
                    <h3>Î©§Î≤Ñ</h3>
                </div>

                <ul class="member-list">

                    <!-- Î©§Î≤Ñ Î™©Î°ù -->
                    <li class="member-item" th:each="m : ${members}">

                        <div class="member-left">
                            <img th:if="${m.user.profileImage != null}"
                                 th:src="@{|/user/profile-image/${m.user.id}|}"
                                 class="member-avatar">
                            <img th:if="${m.user.profileImage == null}"
                                 src="/images/defaultProfilePicture.png"
                                 class="member-avatar">

                            <div class="member-name-wrap">
                                <span class="member-name" th:text="${m.user.nickname}">ÎãâÎÑ§ÏûÑ</span>

                                <div class="member-dropdown">
                                    <a th:href="@{|/user/mypage/${m.user.id}|}" class="dropdown-item">ÎßàÏù¥ÌéòÏù¥ÏßÄ</a>
                                    <a th:if="${session.user == null}" href="/user/login_form" class="dropdown-item">1:1 Ï±ÑÌåÖ</a>
                                    <a th:if="${session.user != null and m.user.id != session.user.id}" href="javascript:void(0);" class="dropdown-item" th:onclick="|openDirectChat(${m.user.id})|">1:1 Ï±ÑÌåÖ</a>
                                </div>
                            </div>

                            <span class="member-role"
                                  th:if="${m.position.name() == 'ADMIN'}">Î™®ÏûÑÏû•</span>
                        </div>

                        <div class="member-right"
                             th:if="${session.user != null and session.user.id != m.user.id and !#lists.contains(reviewedTargetIds, m.user.id)}">
                            <a th:href="@{|/review/user/${group.id}/${m.user.id}|}"
                               class="btn-rate-user">
                                ÌèâÍ∞ÄÌïòÍ∏∞
                            </a>
                        </div>

                        <div class="member-right"
                             th:if="${session.user != null
              and session.user.id != m.user.id
              and #lists.contains(reviewedTargetIds, m.user.id)}">
                            <span style="font-size:12px; color:#999; font-weight:600;">ÌèâÍ∞ÄÏôÑÎ£å</span>
                        </div>

                    </li>

                    <!-- Î©§Î≤Ñ ÏóÜÏùÑ Îïå -->
                    <li class="member-item empty"
                        th:if="${members == null or #lists.isEmpty(members)}">
                        Î©§Î≤ÑÍ∞Ä ÏóÜÏäµÎãàÎã§.
                    </li>

                </ul>
            </div>

            <!-- ÏùºÏ†ï Î∞ïÏä§ -->
            <div class="box">
                <div class="box-header">
                    <h3>ÏùºÏ†ï</h3>

                    <button type="button" class="btn-export-schedule"
                            th:onclick="|location.href='@{/schedule/group/{groupId}/export(groupId=${group.id})}'|">
                        <span>üì•</span> ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                    </button>
                </div>

                <div class="calendar-wrapper" th:with="groupId=${group.id}">
                    <th:block th:replace="~{schedule/calendar_fragment :: calendarFragment(apiUrl=@{/api/schedule(groupId=${group.id})}, canAdd=false)}">
                    </th:block>
                </div>
            </div>

            <!--  Î¶¨Î∑∞ ÌÜµÍ≥Ñ ÏÑπÏÖò (Overall) -->
            <!-- TODO ÎîîÏûêÏù∏ ÎßàÍ∞êÎïå ÌÜµÏùºÍ∞ê ÎßûÏ∂îÍ∏∞ -->
            <div class="review-stats-section" style="margin-top: 50px; padding: 30px; background: #F9F9F9; border-radius: 16px; border: 1px solid #EEE;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: 700; margin: 0; color: #333;">
                        Í∑∏Î£π Î¶¨Î∑∞ <span style="color:#134D38;">([[${stats.reviewCount}]])</span>
                    </h3>
                    <a th:href="@{|/review/group/${group.id}/list|}" style="font-size: 14px; color: #666; text-decoration: none;">
                        Î¶¨Î∑∞ ÎçîÎ≥¥Í∏∞ >
                    </a>
                </div>

                <div style="display: flex; gap: 40px; align-items: center;">
                    <!-- ÏôºÏ™Ω: Ï¢ÖÌï© Ï†êÏàò -->
                    <div style="text-align: center; width: 150px;">
                        <div style="font-size: 48px; font-weight: 800; color: #134D38;" th:text="${stats.averageTotal}">0.0</div>

                        <!-- Î≥ÑÏ†ê Í∑∏ÎûòÌîÑ -->
                        <div class="star-rating-display" th:title="|ÌèâÏ†ê ${stats.averageTotal}Ï†ê|">
                            <div class="star-base">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                            <div class="star-fill" th:style="'width:' + ${(stats.averageTotal / 5.0) * 100} + '%'">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                        </div>
                        <div style="font-size: 13px; color: #888; margin-top: 5px;">Ï¢ÖÌï© ÌèâÏ†ê</div>
                    </div>

                    <!-- Ïò§Î•∏Ï™Ω: Ìï≠Î™©Î≥Ñ Ï†êÏàò (Î∞î Í∑∏ÎûòÌîÑ) -->
                    <div style="flex: 1;">
                        <!-- 1. Ï∞∏Ïó¨/Ïã†Î¢∞ÎèÑ -->
                        <div style="margin-bottom: 12px;">
                            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; color:#555; font-weight:600;">
                                <span>Ï∞∏Ïó¨/Ïã†Î¢∞ÎèÑ</span> <span th:text="${stats.averageReliability}">0.0</span>
                            </div>
                            <div style="background:#E0E0E0; height:8px; border-radius:4px; overflow:hidden;">
                                <div th:style="'background-color:#134D38; height:100%; width:' + ${stats.averageReliability * 20} + '%'"></div>
                            </div>
                        </div>

                        <!-- 2. Ï§ÄÎπÑ/Ïö¥ÏòÅ -->
                        <div style="margin-bottom: 12px;">
                            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; color:#555; font-weight:600;">
                                <span>Ï§ÄÎπÑ/Ïö¥ÏòÅ</span> <span th:text="${stats.averagePreparation}">0.0</span>
                            </div>
                            <div style="background:#E0E0E0; height:8px; border-radius:4px; overflow:hidden;">
                                <div th:style="'background-color:#134D38; height:100%; width:' + ${stats.averagePreparation * 20} + '%'"></div>
                            </div>
                        </div>

                        <!-- 3. ÎßåÏ°±ÎèÑ/Ïû¨ÎØ∏ -->
                        <div>
                            <div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:4px; color:#555; font-weight:600;">
                                <span>ÎßåÏ°±ÎèÑ/Ïû¨ÎØ∏</span> <span th:text="${stats.averageSatisfaction}">0.0</span>
                            </div>
                            <div style="background:#E0E0E0; height:8px; border-radius:4px; overflow:hidden;">
                                <div th:style="'background-color:#134D38; height:100%; width:' + ${stats.averageSatisfaction * 20} + '%'"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${isUserExist} and !${isReviewed}" style="text-align: center; margin-top: 30px;">
                    <a th:href="@{|/review/group/${group.id}|}"
                       style="display:inline-block; background:white; border:1px solid #134D38; color:#134D38; padding:10px 30px; border-radius:50px; text-decoration:none; font-weight:700; transition:0.2s;"
                       onmouseover="this.style.backgroundColor='#E8F5E9'"
                       onmouseout="this.style.backgroundColor='white'">
                        ‚úçÔ∏è Î¶¨Î∑∞ ÏûëÏÑ±ÌïòÍ∏∞
                    </a>
                </div>


            </div> <!-- content-area ÎÅù -->


            <!-- Í∑∏Î£π ÏÑ§Ï†ï / ÎÇòÍ∞ÄÍ∏∞ Î≤ÑÌäº -->
            <div class="group-settings-box">

                <!--  Î™®ÏûÑÏû•(Admin)Ïùº Îïå: ÏÑ§Ï†ï Î≤ÑÌäº -->
                <a th:if="${isAdmin}"
                   th:href="@{/group/settings/{id}(id=${group.id})}"
                   class="settings-btn">
                    ÏÑ§Ï†ï
                </a>

                <!--  ÏùºÎ∞ò Î©§Î≤ÑÏùº Îïå: ÎÇòÍ∞ÄÍ∏∞ Î≤ÑÌäº -->
                <form th:if="${!isAdmin}"
                      th:action="@{/group/leave/{id}(id=${group.id})}"
                      method="post"
                      onsubmit="return confirm('Ï†ïÎßê ÏÜåÎ™®ÏûÑÏóêÏÑú ÎÇòÍ∞ÄÏãúÍ≤†ÏäµÎãàÍπå?');">
                    <button type="submit" class="leave-btn">ÌÉàÌá¥</button>
                </form>

            </div>


        </div> <!-- group-home-wrapper ÎÅù -->
    </div>
</div>
    <script th:inline="javascript">
        // ÎãâÎÑ§ÏûÑ ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.addEventListener('DOMContentLoaded', function() {
            const memberNicknames = document.querySelectorAll('.member-name');

            memberNicknames.forEach(nickname => {
                nickname.addEventListener('click', function(event) {
                    event.stopPropagation(); // Ïù¥Î≤§Ìä∏ Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ

                    // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥Î•º Îã´Í∏∞
                    document.querySelectorAll('.member-dropdown').forEach(dropdown => {
                        if (dropdown !== this.nextElementSibling) {
                            dropdown.classList.remove('active');
                        }
                    });

                    // ÌÅ¥Î¶≠Îêú ÎãâÎÑ§ÏûÑ Î∞îÎ°ú Îã§ÏùåÏóê ÏûàÎäî ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥Î•º ÌÜ†Í∏Ä
                    const dropdown = this.nextElementSibling;
                    if (dropdown && dropdown.classList.contains('member-dropdown')) {
                        dropdown.classList.toggle('active');
                    }
                });
            });

            // ÌôîÎ©¥ ÏïÑÎ¨¥ Í≥≥Ïù¥ÎÇò ÌÅ¥Î¶≠Ìï¥ÏÑú ÎìúÎ°≠Îã§Ïö¥ Î©îÎâ¥ Îã´Í∏∞
            document.addEventListener('click', function() {
                document.querySelectorAll('.member-dropdown.active').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            });
        });
    </script>
</th:block>

</body>
</html>
