<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Moeim</title>

    <!-- ê³µí†µ ìŠ¤íƒ€ì¼ -->
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/main.css}">
    <link rel="stylesheet" th:href="@{/css/schedule/calendar.css}">
    <link rel="stylesheet" th:href="@{/css/chat/chat_widget.css}">

    <!-- ì±„íŒ… ì…ë ¥ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ -->
    <style>
    </style>
</head>

<body th:with="loginUser=${session.user}"
      th:attr="data-login-user-id=${loginUser != null ? loginUser.id : 0}">

<!-- ======================= HEADER ======================= -->
<header class="header">
    <div class="header-inner">

        <!-- ë¡œê³  -->
        <a href="/" class="logo-area">
            <img th:src="@{/images/logo.png}" alt="logo">
            <span class="logo-text">MOEIM</span>
        </a>

        <!-- ë©”ë‰´ -->
        <nav class="menu">
            <a th:if="${session.user == null}" th:href="@{/user/login_form}">ë¡œê·¸ì¸</a>
            <a th:if="${session.user != null}" th:href="@{/user/logout}">ë¡œê·¸ì•„ì›ƒ</a>
            <span>|</span>
            <a th:href="@{/faq/faq}">FAQ</a>
            <span>|</span>
            <a th:href="@{/category/0}">ì»¤ë®¤ë‹ˆí‹°</a>
            <span>|</span>
            <a th:href="@{/group/list}">ì†Œëª¨ì„</a>
            <span th:if="${session.user != null}">|</span>
            <a th:if="${session.user != null}" th:href="@{/user/mypage}">ë§ˆì´í˜ì´ì§€</a>
        </nav>

    </div>
</header>

<!-- ======================= ì±„íŒ… í”Œë¡œíŒ… ë²„íŠ¼ & íŒ¨ë„ ======================= -->

<!-- ì™¼ìª½ ì•„ë˜ ë‘¥ê·¼ ë²„íŠ¼ -->
<div id="chat-floating-btn" class="chat-floating-btn" th:if="${session.user != null}">
    ğŸ’¬
    <span id="chat-global-unread" class="chat-unread-badge hidden">0</span>
</div>

<!-- ì±„íŒ… íŒ¨ë„ -->
<div id="chat-panel" class="chat-panel">
    <div class="chat-panel-header">
        <span id="chat-room-title">ëŒ€í™” ìƒëŒ€ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
        <button type="button" id="chat-close-btn" class="chat-close-btn">âœ•</button>
    </div>

    <!-- íƒ­ -->
    <div class="chat-panel-tabs">
        <button class="chat-tab-btn active" data-tab="group">ê·¸ë£¹ ì±„íŒ…</button>
        <button class="chat-tab-btn" data-tab="direct">1:1 ì±„íŒ…</button>
        <button class="chat-tab-btn" data-tab="random">ëœë¤ ì±„íŒ…</button>
    </div>

    <!-- ë³¸ë¬¸: ì™¼ìª½ ë°© ë¦¬ìŠ¤íŠ¸ + ì˜¤ë¥¸ìª½ ëŒ€í™”ì°½ -->
    <div class="chat-panel-body">
        <!-- ì™¼ìª½: ë°© ë¦¬ìŠ¤íŠ¸/ëœë¤ ë§¤ì¹­ -->
        <div class="chat-sidebar">
            <!-- ê·¸ë£¹ ì±„íŒ… ë¦¬ìŠ¤íŠ¸ -->
            <div class="chat-tab-content" id="chat-tab-group">
                <div class="chat-list" id="chat-group-list">
                    ë¡œë”© ì¤‘...
                </div>
            </div>

            <!-- 1:1 ì±„íŒ… ë¦¬ìŠ¤íŠ¸ -->
            <div class="chat-tab-content hidden" id="chat-tab-direct">
                <div class="chat-list" id="chat-direct-list">
                    ì•„ì§ 1:1 ì±„íŒ… ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
            </div>

            <!-- ëœë¤ ì±„íŒ… -->
            <div class="chat-tab-content hidden" id="chat-tab-random">
                <div id="random-chat-status">
                    <p class="random-status-text">ëœë¤ ë§¤ì¹­ ìƒëŒ€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤...</p>
                    <button type="button" id="random-chat-start-btn" class="chat-random-btn">
                        ë§¤ì¹­ ì‹œì‘
                    </button>
                    <button type="button" id="random-chat-cancel-btn"
                            class="chat-random-btn secondary hidden">
                        ë§¤ì¹­ ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì‹¤ì œ ëŒ€í™”ì°½ -->
        <div class="chat-main">
            <div class="chat-main-header">
                <!-- ìœ„ìª½ í—¤ë” íƒ€ì´í‹€ -->
                <span id="chat-main-title">ì±„íŒ…</span>
            </div>

            <div class="chat-message-container">
                <ul id="chat-message-list" class="chat-message-list">
                    <li class="chat-message-system">
                        ì™¼ìª½ì—ì„œ ì±„íŒ…ë°©ì„ ì„ íƒí•˜ê±°ë‚˜, ë§ˆì´í˜ì´ì§€ì—ì„œ [ë©”ì‹œì§€ ë³´ë‚´ê¸°]ë¥¼ ëˆŒëŸ¬ ì‹œì‘í•˜ì„¸ìš”.
                    </li>
                </ul>
            </div>

            <form id="chat-send-form" class="chat-send-form">
                <textarea id="chat-input"
                          class="chat-input"
                          rows="1"
                          placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                          autocomplete="off"></textarea>
                <button type="submit" id="chat-send-btn" class="chat-send-btn">ì „ì†¡</button>
            </form>
        </div>
    </div>
</div>

<!-- ======================= í˜ì´ì§€ ì»¨í…ì¸  ======================= -->

<th:block layout:fragment="content"></th:block>

<script>
    function openSidebar() {
        console.log("ì‚¬ì´ë“œë°” ì—´ê¸°");
    }
</script>

<th:block layout:fragment="script"></th:block>

<!-- ======================= FOOTER ======================= -->
<footer class="site-footer">
    <div class="footer-inner">

        <a href="https://github.com/happylife10201020/OpenSW_group3"
           class="footer-link"
           target="_blank"
           rel="noopener noreferrer">
            GitHub
        </a>

        <span class="footer-text">
            Â© 2025 Moeim. All rights reserved.
        </span>


        <span class="footer-members">
                ì„œë¯¼ì„ Â· ì´ì¸ìˆ˜ Â· ìµœìƒì˜ Â· Ali Zarq
            </span>
    </div>
</footer>
<!-- ======================= FOOTER END ======================= -->


<!-- ======================= ì±„íŒ… ìœ„ì ¯ ìŠ¤í¬ë¦½íŠ¸ ======================= -->

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // í˜„ì¬ ì„ íƒëœ ë°© / íƒ€ì…
        let currentRoomId = null;
        let currentRoomType = null;   // 'GROUP' | 'DIRECT' | 'RANDOM'
        let messagePollTimer = null;

        const chatBtn = document.getElementById('chat-floating-btn');
        const chatPanel = document.getElementById('chat-panel');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const tabButtons = document.querySelectorAll('.chat-tab-btn');
        const tabGroup = document.getElementById('chat-tab-group');
        const tabDirect = document.getElementById('chat-tab-direct');
        const tabRandom = document.getElementById('chat-tab-random');

        const groupListEl = document.getElementById('chat-group-list');
        const directListEl = document.getElementById('chat-direct-list');
        const randomStartBtn = document.getElementById('random-chat-start-btn');
        const randomCancelBtn = document.getElementById('random-chat-cancel-btn');

        const chatRoomTitleEl = document.getElementById('chat-room-title');
        const chatMainTitleEl = document.getElementById('chat-main-title');
        const messageListEl = document.getElementById('chat-message-list');
        // ì‹¤ì œ ìŠ¤í¬ë¡¤ì´ ê±¸ë¦¬ëŠ” ì»¨í…Œì´ë„ˆ ê¸°ì¤€
        const messageScrollEl = document.querySelector('.chat-message-container') || messageListEl;

        const sendForm = document.getElementById('chat-send-form');
        const inputEl = document.getElementById('chat-input');
        const sendBtn = document.getElementById('chat-send-btn');

        const globalUnreadEl = document.getElementById('chat-global-unread');

        // ===== ì…ë ¥/ì „ì†¡ ë²„íŠ¼ í™œì„±/ë¹„í™œì„± ì œì–´ =====
        function setSendFormEnabled(enabled) {
            if (!inputEl || !sendBtn) return;

            if (enabled) {
                inputEl.disabled = false;
                inputEl.classList.remove('disabled');

                sendBtn.disabled = false;
                sendBtn.classList.remove('disabled');
            } else {
                inputEl.value = '';
                inputEl.disabled = true;
                inputEl.classList.add('disabled');

                sendBtn.disabled = true;
                sendBtn.classList.add('disabled');
            }
        }

        // ì²˜ìŒì—ëŠ” ë°©ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë¹„í™œì„±í™”
        setSendFormEnabled(false);

        // ===== ìƒë‹¨ ë¹¨ê°„ ë°°ì§€ =====
        function updateGlobalUnreadBadge(count) {
            if (!globalUnreadEl) return;
            if (!count || count <= 0) {
                globalUnreadEl.classList.add('hidden');
            } else {
                globalUnreadEl.textContent = count > 99 ? '99+' : count;
                globalUnreadEl.classList.remove('hidden');
            }
        }

        function refreshUnreadCount() {
            fetch('/api/chat/unread-count')
                .then(res => res.ok ? res.json() : {totalUnread: 0})
                .then(data => {
                    updateGlobalUnreadBadge(data.totalUnread || 0);
                })
                .catch(() => {
                });
        }

        const bodyTag = document.querySelector('body');
        const loginUserId = bodyTag ? parseInt(bodyTag.getAttribute('data-login-user-id') || '0') : 0;
        if (loginUserId > 0) {
            refreshUnreadCount();
            setInterval(refreshUnreadCount, 3000); // 3ì´ˆë§ˆë‹¤ ê°±ì‹ 
        }

        // ===== íŒ¨ë„ ì—´ê³  ë‹«ê¸° =====
        function openChatPanelInternal() {
            if (chatPanel) {
                chatPanel.classList.add('open');
            }
            if (currentRoomId) {
                setSendFormEnabled(true);
            } else {
                setSendFormEnabled(false);
            }
        }

        function stopMessagePolling() {
            if (messagePollTimer != null) {
                clearInterval(messagePollTimer);
                messagePollTimer = null;
            }
        }

        function closeChatPanelInternal() {
            if (chatPanel) {
                chatPanel.classList.remove('open');
            }
            stopMessagePolling();
        }

        window.openChatPanel = openChatPanelInternal;

        if (chatBtn) {
            chatBtn.addEventListener('click', function () {
                if (chatPanel.classList.contains('open')) {
                    closeChatPanelInternal();
                } else {
                    openChatPanelInternal();
                    setActiveTab('group');
                }
            });
        }
        if (chatCloseBtn) {
            chatCloseBtn.addEventListener('click', closeChatPanelInternal);
        }

        // ===== íƒ­ ì „í™˜ =====
        function setActiveTab(tabName) {
            tabButtons.forEach(b => {
                b.classList.toggle('active', b.dataset.tab === tabName);
            });

            if (tabGroup) tabGroup.classList.toggle('hidden', tabName !== 'group');
            if (tabDirect) tabDirect.classList.toggle('hidden', tabName !== 'direct');
            if (tabRandom) tabRandom.classList.toggle('hidden', tabName !== 'random');

            if (tabName === 'group') {
                loadGroupChatRooms();
            } else if (tabName === 'direct') {
                loadDirectChatRooms();
            }
        }

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                setActiveTab(btn.dataset.tab);
            });
        });

        // ===== ë©”ì‹œì§€ ì£¼ê¸°ì  ê°±ì‹  =====
        function startMessagePolling() {
            stopMessagePolling();
            if (!currentRoomId) return;
            messagePollTimer = setInterval(() => {
                loadMessagesForRoom(currentRoomId, true); // silent
            }, 2500);
        }

        // ===== íŠ¹ì • ë°© ì½ìŒ ì²˜ë¦¬ =====
        function markRoomAsRead(roomId, lastMessageId) {
            if (!lastMessageId) return;
            if (!chatPanel || !chatPanel.classList.contains('open')) return;

            fetch('/api/chat/rooms/' + roomId + '/read', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({lastMessageId: lastMessageId})
            }).then(() => {
                refreshUnreadCount();

                if (currentRoomType === 'DIRECT') {
                    loadDirectChatRooms();
                } else if (currentRoomType === 'GROUP') {
                    loadGroupChatRooms();
                }
            }).catch(() => {
            });
        }

        // ===== ë§ˆì§€ë§‰ ë‚´ ë©”ì‹œì§€ê°€ ì½í˜”ìœ¼ë©´, ë‚´ ë©”ì‹œì§€ ì „ì²´ì— ì½ìŒí‘œì‹œ =====
        function updateLastMineReadMark(list) {
            if (!Array.isArray(list) || list.length === 0) return;

            // 1. ìµœê·¼ 'ë‚´ ë©”ì‹œì§€' í•˜ë‚˜ ì°¾ê¸°
            let lastMine = null;
            for (let i = list.length - 1; i >= 0; i--) {
                const m = list[i];
                if (m.mine) {
                    lastMine = m;
                    break;
                }
            }

            // ë‚´ ë©”ì‹œì§€ê°€ í•˜ë‚˜ë„ ì—†ê±°ë‚˜, "ê°€ì¥ ìµœê·¼ ë‚´ ë©”ì‹œì§€"ê°€ ì•„ì§ ì•ˆ ì½íŒ ìƒíƒœë©´ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
            if (!lastMine || !lastMine.readByAll) {
                return;
            }

            // 2. DOMì—ì„œ ë‚´ ë©”ì‹œì§€(li.chat-message.mine) ì „ë¶€ì— ì½ìŒí‘œì‹œ ì¶”ê°€
            const mineNodes = messageListEl.querySelectorAll('li.chat-message.mine');
            if (!mineNodes || mineNodes.length === 0) return;

            mineNodes.forEach(li => {
                const metaEl = li.querySelector('.chat-message-meta');
                if (!metaEl) return;

                // ì´ë¯¸ ë¶™ì–´ ìˆìœ¼ë©´ ë˜ ì•ˆ ë¶™ì„
                if (metaEl.querySelector('.chat-message-read')) return;

                const span = document.createElement('span');
                span.className = 'chat-message-read';
                span.textContent = 'ì½ìŒ';
                // ì‹œê°„ ì•ìª½ì— ë¼ì›Œ ë„£ê¸°
                metaEl.insertBefore(span, metaEl.firstChild);
            });
        }

        // ===== íŠ¹ì • ë°© ë©”ì‹œì§€ ë¡œë”© (ê¹œë¹¡ì„ ìµœì†Œí™” + ìë™ ìŠ¤í¬ë¡¤ + ì½ìŒí‘œì‹œ ì—…ë°ì´íŠ¸) =====
        function loadMessagesForRoom(roomId, silent) {
            if (!messageListEl || !messageScrollEl || !roomId) return;

            if (!chatPanel || !chatPanel.classList.contains('open')) {
                return;
            }

            const nearBottom =
                messageScrollEl.scrollHeight - messageScrollEl.scrollTop - messageScrollEl.clientHeight < 50;

            // ë©”íƒ€ ì˜ì—­ HTML ìƒì„± ê³µí†µ í•¨ìˆ˜
            function buildMetaHtml(m) {
                const isReadByAll = (currentRoomType === 'DIRECT' && m.readByAll);

                const readMark =
                    (m.mine && isReadByAll)
                        ? '<span class="chat-message-read">ì½ìŒ</span>'
                        : '';

                let groupUnreadMark = '';
                if (currentRoomType === 'GROUP' &&
                    typeof m.unreadMemberCount === 'number' &&
                    m.unreadMemberCount > 0) {
                    groupUnreadMark =
                        `<span class="chat-message-unread-count">${m.unreadMemberCount}</span>`;
                }

                return `
            ${readMark}
            ${groupUnreadMark}
            <span class="chat-message-time">
                ${m.createdAt ? m.createdAt.slice(11, 16) : ''}
            </span>
        `;
            }

            fetch('/api/chat/rooms/' + roomId + '/messages')
                .then(res => {
                    if (!res.ok) throw new Error('ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                    return res.json();
                })
                .then(list => {
                    if (!Array.isArray(list) || list.length === 0) {
                        if (!messageListEl.dataset.lastMessageId) {
                            messageListEl.innerHTML =
                                '<li class="chat-message-system">ì•„ì§ ì£¼ê³ ë°›ì€ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                        }
                        messageListEl.dataset.lastMessageId = '';
                        return;
                    }

                    // ë©”ì‹œì§€ í•˜ë‚˜ ë Œë”ë§
                    function renderMessage(m) {
                        const li = document.createElement('li');
                        li.className = 'chat-message ' + (m.mine ? 'mine' : 'theirs');

                        // ê·¸ë£¹ ì±„íŒ…ì´ê³  ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ê°€ ì•„ë‹Œ ê²½ìš° â†’ í”„ë¡œí•„ ì´ë¯¸ì§€ + ë‹‰ë„¤ì„
                        if (currentRoomType === 'GROUP' && !m.mine) {
                            li.classList.add('group-other');

                            const profileUrl = m.senderProfileImageUrl
                                || '/images/defaultProfilePicture.png';

                            li.innerHTML = `
                        <div class="chat-message-avatar">
                            <img src="${profileUrl}"
                                 onerror="this.src='/images/defaultProfilePicture.png'"
                                 alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
                        </div>
                        <div class="chat-message-body">
                            <div class="chat-message-sender">
                                ${m.senderNickname || 'ì‚¬ìš©ì'}
                            </div>
                            <div class="chat-message-content-wrapper">
                                <div class="chat-message-bubble">
                                    <div class="chat-message-content"></div>
                                </div>
                                <div class="chat-message-meta">
                                    ${buildMetaHtml(m)}
                                </div>
                            </div>
                        </div>
                    `;
                        } else {
                            // 1:1 ì´ê±°ë‚˜, ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ â†’ ê¸°ì¡´ ë²„ë¸” ë ˆì´ì•„ì›ƒ
                            li.innerHTML = `
                        <div class="chat-message-bubble">
                            <div class="chat-message-content"></div>
                        </div>
                        <div class="chat-message-meta">
                            ${buildMetaHtml(m)}
                        </div>
                    `;
                        }

                        const contentEl = li.querySelector('.chat-message-content');
                        if (contentEl) {
                            contentEl.textContent = m.content;
                        }
                        messageListEl.appendChild(li);
                    }

                    if (!silent) {
                        // ë°©ì„ ì²˜ìŒ ì—´ê±°ë‚˜ ë‚´ê°€ ì „ì†¡ ì§í›„ ë“± â†’ ì „ì²´ ë‹¤ì‹œ ê·¸ë¦¼
                        messageListEl.innerHTML = '';
                        list.forEach(renderMessage);
                    } else {
                        const lastRenderedId = messageListEl.dataset.lastMessageId;
                        let startIndex = 0;

                        if (lastRenderedId) {
                            const idx = list.findIndex(m => String(m.id) === lastRenderedId);
                            if (idx >= 0) {
                                startIndex = idx + 1;
                            }
                        }

                        const hasNewMessages = startIndex < list.length;

                        if (hasNewMessages) {
                            for (let i = startIndex; i < list.length; i++) {
                                renderMessage(list[i]);
                            }
                        }

                        // ìƒˆ ë©”ì‹œì§€ê°€ ì—†ë”ë¼ë„, ê¸°ì¡´ ë©”ì‹œì§€ì˜ ì½ìŒ ìƒíƒœ ë° ê·¸ë£¹ unread ìˆ«ì ì—…ë°ì´íŠ¸
                        if (!hasNewMessages) {
                            const existingMessages = messageListEl.querySelectorAll('.chat-message');
                            const messagesToUpdate = list.slice(-existingMessages.length);

                            messagesToUpdate.forEach((m, index) => {
                                const li = existingMessages[index];
                                if (!li) return;

                                const metaEl = li.querySelector('.chat-message-meta');
                                if (metaEl) {
                                    metaEl.innerHTML = buildMetaHtml(m);
                                }
                            });
                        }
                    }

                    const last = list[list.length - 1];
                    if (last) {
                        messageListEl.dataset.lastMessageId = String(last.id);
                        markRoomAsRead(roomId, last.id);
                    }

                    if (nearBottom || !silent) {
                        messageScrollEl.scrollTop = messageScrollEl.scrollHeight;
                    }
                })
                .catch(err => {
                    console.error(err);
                    if (!silent) {
                        messageListEl.innerHTML =
                            '<li class="chat-message-system error">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>';
                    }
                });
        }


        // ===== ë°© í™œì„±í™” (ì œëª© ì„¸íŒ… + ë©”ì‹œì§€ ë¡œë”© + í´ë§ ì‹œì‘) =====
        function setActiveRoom(roomId, title, type) {
            currentRoomId = roomId;
            currentRoomType = type || null;

            const titleText = title || 'ì±„íŒ…';

            if (chatRoomTitleEl) {
                chatRoomTitleEl.textContent = titleText;
            }
            if (chatMainTitleEl) {
                chatMainTitleEl.textContent = titleText;
            }

            if (messageListEl) {
                messageListEl.innerHTML =
                    '<li class="chat-message-system">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>';
                messageListEl.dataset.lastMessageId = '';
            }

            setSendFormEnabled(true);

            openChatPanelInternal();
            loadMessagesForRoom(roomId, false);
            startMessagePolling();
        }

        // ===== ë©”ì‹œì§€ ì „ì†¡ =====
        if (sendForm && inputEl && sendBtn) {
            sendForm.addEventListener('submit', function (e) {
                e.preventDefault();
                if (!currentRoomId) {
                    alert('ë¨¼ì € ì±„íŒ…ë°©ì„ ì„ íƒí•˜ì„¸ìš”.');
                    return;
                }
                if (sendBtn.disabled || inputEl.disabled) {
                    return;
                }

                const text = inputEl.value.trim();
                if (!text) return;

                fetch('/api/chat/rooms/' + currentRoomId + '/messages', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content: text})
                })
                    .then(res => {
                        if (!res.ok) throw new Error('ì „ì†¡ ì‹¤íŒ¨');
                        return res.json();
                    })
                    .then(() => {
                        inputEl.value = '';
                        loadMessagesForRoom(currentRoomId, false);
                        if (messageScrollEl) {
                            setTimeout(() => {
                                messageScrollEl.scrollTop = messageScrollEl.scrollHeight;
                            }, 50);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert('ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    });
            });

            // Enter ë¡œ ì „ì†¡, Shift+Enter ëŠ” ì¤„ë°”ê¿ˆ
            inputEl.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendForm.dispatchEvent(new Event('submit', {cancelable: true}));
                }
            });
        }

        // ===== ê·¸ë£¹ ì±„íŒ…ë°© ëª©ë¡ ë¡œë”© =====
        function loadGroupChatRooms() {
            if (!groupListEl) return;
            groupListEl.innerHTML = 'ë¡œë”© ì¤‘...';

            fetch('/api/chat/my-groups')
                .then(res => {
                    if (!res.ok) throw new Error('ê¶Œí•œ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        groupListEl.innerHTML =
                            '<div style="color:#999; font-size:12px; text-align:center; margin-top:20px;">ì°¸ì—¬ ì¤‘ì¸ ê·¸ë£¹ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    groupListEl.innerHTML = '';
                    data.forEach(room => {
                        const div = document.createElement('div');
                        div.className = 'chat-list-item';

                        //  [ìˆ˜ì •] unreadCountê°€ 0ë³´ë‹¤ í´ ê²½ìš° ë°°ì§€ HTML ìƒì„±
                        const badgeHtml = room.unreadCount && room.unreadCount > 0
                            ? `<span class="chat-unread-badge-inline">${room.unreadCount}</span>`
                            : '';

                        div.innerHTML = `
        <div class="chat-list-title">
            ${room.groupTitle || room.name || 'ê·¸ë£¹ ì±„íŒ…'}
            ${badgeHtml} </div>
        <div class="chat-list-meta">
            ${room.lastMessagePreview || ''}
            ${room.unreadCount ? ' â€¢ ë¯¸í™•ì¸ ' + room.unreadCount + 'ê°œ' : ''}
        </div>
    `;
                        div.addEventListener('click', () => {
                            setActiveRoom(
                                room.roomId,
                                room.groupTitle || room.name || 'ê·¸ë£¹ ì±„íŒ…',
                                'GROUP'
                            );
                        });
                        groupListEl.appendChild(div);
                    });
                })
                .catch(err => {
                    console.error(err);
                    groupListEl.innerHTML =
                        '<div style="color:#c92a2a; font-size:12px; text-align:center; margin-top:20px;">ê·¸ë£¹ ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                });
        }

        // ===== 1:1 ì±„íŒ… ëª©ë¡ ë¡œë”© =====
        function loadDirectChatRooms() {
            if (!directListEl) return;
            directListEl.innerHTML = 'ë¡œë”© ì¤‘...';

            fetch('/api/chat/my-direct')
                .then(res => {
                    if (!res.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
                    return res.json();
                })
                .then(data => {
                    if (!Array.isArray(data) || data.length === 0) {
                        directListEl.innerHTML =
                            '<div style="color:#999; font-size:12px; text-align:center; margin-top:20px;">ì§„í–‰ ì¤‘ì¸ 1:1 ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                        return;
                    }

                    directListEl.innerHTML = '';
                    data.forEach(room => {
                        const div = document.createElement('div');
                        div.className = 'chat-list-item';

                        const badgeHtml = room.unreadCount && room.unreadCount > 0
                            ? `<span class="chat-unread-badge-inline">${room.unreadCount}</span>`
                            : '';

                        div.innerHTML = `
                            <div class="chat-list-title">
                                ${room.partnerNickname || 'ìƒëŒ€ë°©'}
                                ${badgeHtml}
                            </div>
                            <div class="chat-list-meta">
                                ${room.lastMessagePreview || ''}
                                ${room.unreadCount ? ' â€¢ ë¯¸í™•ì¸ ' + room.unreadCount + 'ê°œ' : ''}
                            </div>
                        `;
                        div.addEventListener('click', () => {
                            setActiveRoom(
                                room.roomId,
                                room.partnerNickname || '1:1 ì±„íŒ…',
                                'DIRECT'
                            );
                        });
                        directListEl.appendChild(div);
                    });
                })
                .catch(err => {
                    console.error(err);
                    directListEl.innerHTML =
                        '<div style="color:#c92a2a; font-size:12px; text-align:center; margin-top:20px;">1:1 ì±„íŒ… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                });
        }

        // ===== ë§ˆì´í˜ì´ì§€ "ë©”ì‹œì§€ ë³´ë‚´ê¸°" ë²„íŠ¼ì—ì„œ í˜¸ì¶œí•˜ëŠ” ì „ì—­ í•¨ìˆ˜ =====
        window.openDirectChat = function (targetUserId) {
            fetch('/api/chat/direct/' + targetUserId, {
                method: 'POST'
            })
                .then(res => {
                    if (!res.ok) throw new Error('ë°© ìƒì„± ì‹¤íŒ¨');
                    return res.json();
                })
                .then(data => {
                    const roomId = data.roomId;
                    const title = data.partnerNickname || '1:1 ì±„íŒ…';
                    setActiveTab('direct');
                    setActiveRoom(roomId, title, 'DIRECT');
                    loadDirectChatRooms();  // ì™¼ìª½ ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
                })
                .catch(err => {
                    console.error(err);
                    alert('ë©”ì‹œì§€ ì „ì†¡ ì¤€ë¹„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                });
        };

        // ===== ëœë¤ ì±„íŒ… (APIëŠ” ì¶”í›„ êµ¬í˜„, í˜„ì¬ëŠ” ê¸°ë³¸ í‹€ë§Œ) =====
        let randomIntervalId = null;

        function pollRandomStatus() {
            if (randomIntervalId != null) return;
            randomIntervalId = setInterval(() => {
                fetch('/api/chat/random/status')
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.roomId) {
                            clearInterval(randomIntervalId);
                            randomIntervalId = null;
                            window.location.href = '/chat/room/' + data.roomId;
                        }
                    })
                    .catch(() => {
                    });
            }, 2000);
        }

        if (randomStartBtn) {
            randomStartBtn.addEventListener('click', () => {
                fetch('/api/chat/random/join', {method: 'POST'})
                    .then(res => {
                        if (!res.ok) throw new Error();
                        return res.json();
                    })
                    .then(data => {
                        if (data.roomId) {
                            window.location.href = '/chat/room/' + data.roomId;
                            return;
                        }
                        randomStartBtn.classList.add('hidden');
                        randomCancelBtn.classList.remove('hidden');
                        pollRandomStatus();
                    })
                    .catch(() => {
                        alert('ëœë¤ ì±„íŒ… ë§¤ì¹­ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    });
            });
        }

        if (randomCancelBtn) {
            randomCancelBtn.addEventListener('click', () => {
                fetch('/api/chat/random/cancel', {method: 'POST'})
                    .finally(() => {
                        randomStartBtn.classList.remove('hidden');
                        randomCancelBtn.classList.add('hidden');
                        if (randomIntervalId != null) {
                            clearInterval(randomIntervalId);
                            randomIntervalId = null;
                        }
                    });
            });
        }
    });
</script>

</body>
</html>
