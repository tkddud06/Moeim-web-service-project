<!-- ë‹¬ë ¥ ì»´í¬ë„ŒíŠ¸: schedule/calendar.html -->
<section class="calendar-card" th:fragment="calendar">

    <link rel="stylesheet" th:href="@{/css/schedule/calendar.css}">
    <div class="calendar-header">
        <div class="calendar-title">
            <span id="calendar-year"></span>ë…„
            <span id="calendar-month"></span>ì›”
        </div>
        <div class="calendar-today">
            ì˜¤ëŠ˜&nbsp;&nbsp;<strong id="calendar-today"></strong>
        </div>
    </div>

    <div class="calendar-body">
        <div class="calendar-weekdays">
            <div>ì¼</div>
            <div>ì›”</div>
            <div>í™”</div>
            <div>ìˆ˜</div>
            <div>ëª©</div>
            <div>ê¸ˆ</div>
            <div>í† </div>
        </div>

        <div class="calendar-grid" id="calendar-grid">
            <!-- JSì—ì„œ ì‹¤ì œ ë‚ ì§œë¡œ ì±„ì›€ -->
        </div>

        <!-- ë‚ ì§œ í´ë¦­ ì‹œ ì¼ì • ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ì¹´ë“œ -->
        <div class="calendar-hover-card" id="calendar-hover-card">
            ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œì˜ ì¼ì •ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
    </div>

    <script th:inline="javascript">
        (function () {

            // === ë¡œê·¸ì¸ ì—¬ë¶€ ===
            const isLoggedIn = /*[[${session.user != null}]]*/ false;

            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth(); // 0 ~ 11
            const date = today.getDate();

            const yearEl = document.getElementById("calendar-year");
            const monthEl = document.getElementById("calendar-month");
            const todayEl = document.getElementById("calendar-today");
            const grid = document.getElementById("calendar-grid");
            const hoverCard = document.getElementById("calendar-hover-card");

            if (!yearEl || !monthEl || !todayEl || !grid || !hoverCard) return;

            // ìƒë‹¨ ë‚ ì§œ í‘œì‹œ
            yearEl.textContent = year;
            monthEl.textContent = (month + 1);
            todayEl.textContent =
                year + "." +
                String(month + 1).padStart(2, "0") + "." +
                String(date).padStart(2, "0");

            // ===== ë‚ ì§œ ê´€ë ¨ ê³µí†µ í•¨ìˆ˜ / ë°ì´í„° =====

            function formatDateKey(d) {
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, "0");
                const da = String(d.getDate()).padStart(2, "0");
                return y + "-" + m + "-" + da;
            }

            const eventsByDate = {}; // ë‚ ì§œë³„ ì¼ì • ëª¨ìœ¼ëŠ” ë§µ

            const pastelColors = [
                '#FFE5EC',
                '#FFF3BF',
                '#D8F5A2',
                '#D0EBFF',
                '#E5DBFF'
            ];

            function getColorForEvent(event) {
                const key = (event.id ? String(event.id) : '') + '|' + (event.title || '');
                let hash = 0;
                for (let i = 0; i < key.length; i++) {
                    hash = (hash * 31 + key.charCodeAt(i)) >>> 0;
                }
                const index = hash % pastelColors.length;
                return pastelColors[index];
            }

            // ì•„ë˜ í˜¸ë²„ ì¹´ë“œì— ì¼ì • ëª©ë¡ ê·¸ë¦¬ëŠ” í•¨ìˆ˜
            function renderDayDetail(dateKey) {
                const list = eventsByDate[dateKey] || [];

                if (!list.length) {
                    hoverCard.innerHTML =
                        '<div class="calendar-hover-header">' + dateKey + '</div>' +
                        '<div class="calendar-hover-empty">ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                let html = '<div class="calendar-hover-header">' + dateKey + '</div>';

                list.forEach(function (ev) {
                    const title = ev.title || "ì œëª© ì—†ìŒ";

                    // DTO í˜•íƒœ(ev.groupId, ev.groupTitle)ì™€
                    // FullCalendar extendedProps ë‘˜ ë‹¤ ì§€ì›
                    const ext = ev.extendedProps || {};
                    const groupTitle = ev.groupTitle || ext.groupTitle || "";
                    const groupId = ev.groupId || ext.groupId || null;

                    let timeStr = "";
                    if (ev.start) {
                        const start = new Date(ev.start);
                        const end = ev.end ? new Date(ev.end) : null;

                        const startStr = start.toLocaleTimeString('ko-KR', {
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        if (end) {
                            const endStr = end.toLocaleTimeString('ko-KR', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            timeStr = startStr + " ~ " + endStr;
                        } else {
                            timeStr = startStr;
                        }
                    }

                    const groupPageUrl = groupId ? ('/group/home/' + groupId) : '';
                    const bannerUrl = groupId
                        ? ('/group/banner/' + groupId)
                        : '/images/default_banner.jpg';

                    // âœ… ê·¸ë£¹ì´ ìˆìœ¼ë©´ <a href="...">ë¡œ ê°ì‹¸ì„œ ë°”ë¡œ ì´ë™
                    if (groupPageUrl) {
                        html +=
                            '<a class="calendar-hover-item" href="' + groupPageUrl + '">' +
                            '  <div class="calendar-hover-thumb">' +
                            '    <img src="' + bannerUrl + '" alt="' + (groupTitle || 'ê·¸ë£¹ ë°°ë„ˆ') + '">' +
                            '  </div>' +
                            '  <div class="calendar-hover-text">' +
                            '    <div class="calendar-hover-title">' + title + '</div>' +
                            '    <div class="calendar-hover-meta">' +
                            (groupTitle ? (groupTitle + ' Â· ') : '') +
                            (timeStr || '') +
                            '    </div>' +
                            '  </div>' +
                            '</a>';
                    } else {
                        // í˜¹ì‹œ ê·¸ë£¹ ì—†ì´ ê°œì¸ ì¼ì • ê°™ì€ ê²Œ ìˆë‹¤ë©´ divë¡œë§Œ í‘œì‹œ
                        html +=
                            '<div class="calendar-hover-item">' +
                            '  <div class="calendar-hover-thumb">' +
                            '    <img src="' + bannerUrl + '" alt="ì¼ì • ë°°ë„ˆ">' +
                            '  </div>' +
                            '  <div class="calendar-hover-text">' +
                            '    <div class="calendar-hover-title">' + title + '</div>' +
                            '    <div class="calendar-hover-meta">' + (timeStr || '') + '</div>' +
                            '  </div>' +
                            '</div>';
                    }
                });

                hoverCard.innerHTML = html;
            }


            // ===== ë‹¬ë ¥ ê·¸ë¦¬ë“œ ìƒì„± (ë¡œê·¸ì¸ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ í•­ìƒ ìˆ«ìëŠ” ê·¸ë¦¼) =====

            const firstDay = new Date(year, month, 1);
            const firstWeekday = firstDay.getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();
            const prevLastDate = new Date(year, month, 0).getDate();
            const totalCells = 42; // 6ì£¼
            const cells = [];

            grid.innerHTML = "";

            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement("div");
                cell.classList.add("calendar-day");

                let cellDate;
                let dayNum;

                if (i < firstWeekday) {
                    // ì´ì „ ë‹¬
                    dayNum = prevLastDate - firstWeekday + 1 + i;
                    cellDate = new Date(year, month - 1, dayNum);
                    cell.classList.add("other-month");
                } else if (i < firstWeekday + lastDate) {
                    // ì´ë²ˆ ë‹¬
                    dayNum = i - firstWeekday + 1;
                    cellDate = new Date(year, month, dayNum);

                    if (dayNum === date) {
                        cell.classList.add("today");
                    }
                } else {
                    // ë‹¤ìŒ ë‹¬
                    dayNum = i - (firstWeekday + lastDate) + 1;
                    cellDate = new Date(year, month + 1, dayNum);
                    cell.classList.add("other-month");
                }

                const numberEl = document.createElement("div");
                numberEl.classList.add("calendar-number");
                numberEl.textContent = dayNum;
                cell.appendChild(numberEl);

                const dateKey = formatDateKey(cellDate);
                cell.dataset.date = dateKey;

                // ë‚ ì§œ í´ë¦­ â†’ ë¡œê·¸ì¸í•œ ê²½ìš°ì—ë§Œ ì•„ë˜ í˜¸ë²„ ì¹´ë“œ ë‚´ìš© ë³€ê²½
                cell.addEventListener("click", function () {
                    if (!isLoggedIn) return;
                    renderDayDetail(dateKey);
                    hoverCard.classList.add("active");
                });

                grid.appendChild(cell);
                cells.push(cell);
            }

            // ğŸ”’ ë¹„ë¡œê·¸ì¸ì¼ ë•Œ: ìˆ«ì/ê·¸ë¦¬ë“œëŠ” ê·¸ëŒ€ë¡œ ë‘ê³ , ì¹´ë“œë§Œ ì•ˆ ë³´ì´ê²Œ + ë” ì´ìƒ ì§„í–‰ ì•ˆ í•¨
            if (!isLoggedIn) {
                hoverCard.style.display = "none";
                return;
            }

            // ===== ì—¬ê¸°ì„œë¶€í„°ëŠ” "ë¡œê·¸ì¸ í•œ ê²½ìš°"ë§Œ ì‹¤í–‰ë¨ =====

            // í˜¸ë²„ ì¹´ë“œ ì•ˆì—ì„œ ê·¸ë£¹ ì¹´ë“œ í´ë¦­ ì‹œ ì´ë™
            // hoverCard.addEventListener('click', function (e) {
            //     const item = e.target.closest('.calendar-hover-item[data-group-url]');
            //     if (!item) return;
            //     const url = item.getAttribute('data-group-url');
            //     if (url) {
            //         window.location.href = url;
            //     }
            // });

            // ë‚´ ì¼ì • API: ì´ë²ˆ ë‹¬ 1ì¼ ~ ë‹¤ìŒ ë‹¬ 1ì¼
            const startParam = formatDateKey(new Date(year, month, 1));
            const endParam = formatDateKey(new Date(year, month + 1, 1));
            const apiUrl = '/api/schedule/mine?start=' + startParam + '&end=' + endParam;

            fetch(apiUrl, {credentials: 'same-origin'})
                .then(function (res) {
                    if (!res.ok) {
                        throw new Error("HTTP " + res.status);
                    }
                    const contentType = res.headers.get("content-type") || "";
                    if (!contentType.includes("application/json")) {
                        throw new Error("Not JSON");
                    }
                    return res.json();
                })
                .then(function (events) {
                    if (!Array.isArray(events)) return;

                    // ë‚ ì§œë³„ë¡œ ëª¨ìœ¼ê¸°
                    events.forEach(function (ev) {
                        if (!ev.start) return;

                        const start = new Date(ev.start);
                        const end = ev.end ? new Date(ev.end) : new Date(ev.start);

                        // ì‹œê°„ì€ ë²„ë¦¬ê³  'ë‚ ì§œ'ë§Œ ë¹„êµí•˜ë„ë¡ ì •ê·œí™”
                        let cur = new Date(start.getFullYear(), start.getMonth(), start.getDate());
                        const last = new Date(end.getFullYear(), end.getMonth(), end.getDate());

                        // ì‹œì‘ì¼ ~ ì¢…ë£Œì¼ ëª¨ë‘ eventsByDateì— ë“±ë¡
                        while (cur <= last) {
                            const key = formatDateKey(cur); // yyyy-MM-dd
                            if (!eventsByDate[key]) eventsByDate[key] = [];
                            eventsByDate[key].push(ev);

                            // ë‹¤ìŒ ë‚ ë¡œ ì´ë™
                            cur.setDate(cur.getDate() + 1);
                        }
                    });

                    // ê° ë‚ ì§œ ì¹¸ì— ì  ì°ê¸°
                    const maxDots = 4;

                    cells.forEach(function (cell) {
                        const key = cell.dataset.date;
                        const list = eventsByDate[key];
                        if (!list || !list.length) return;

                        cell.classList.add("has-events");

                        const dotsWrap = document.createElement("div");
                        dotsWrap.classList.add("calendar-dots");

                        list.slice(0, maxDots).forEach(function (ev) {
                            const dot = document.createElement("span");
                            dot.classList.add("calendar-dot");
                            dot.style.backgroundColor = getColorForEvent(ev);
                            dotsWrap.appendChild(dot);
                        });

                        if (list.length > maxDots) {
                            const more = document.createElement("span");
                            more.classList.add("calendar-more");
                            more.textContent = "+" + (list.length - maxDots);
                            dotsWrap.appendChild(more);
                        }

                        cell.appendChild(dotsWrap);
                    });

                })
                .catch(function (err) {
                    console.warn("ë‚´ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ", err);
                });


            //í˜¸ë²„ ë‹«ê¸°
            // íŒì—… ë‚´ë¶€ í´ë¦­ì€ ë²„ë¸”ë§ ë§‰ê¸° (ë‹«íˆì§€ ì•Šê²Œ)
            hoverCard.addEventListener("click", function (e) {
                e.stopPropagation();
            });

            // ë°”ê¹¥ ì•„ë¬´ ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ íŒì—… ë‹«ê¸°
            document.addEventListener("click", function (e) {
                if (!hoverCard.classList.contains("active")) return;

                // ë‚ ì§œì¹¸ í´ë¦­ì€ íŒì—… ì—´ê¸° ìš©ì´ë‹ˆ ì—¬ê¸°ì„œëŠ” ë‹«ì§€ ì•ŠìŒ
                const isDayCell = e.target.closest(".calendar-day");
                if (isDayCell) return;

                hoverCard.classList.remove("active");
            });
        })();


    </script>

</section>
