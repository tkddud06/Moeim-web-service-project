<!doctype html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
    <title th:text="${isOwner} ? 'ÎßàÏù¥ÌéòÏù¥ÏßÄ | Moeim' : 'ÌöåÏõê ÌéòÏù¥ÏßÄ | Moeim'">
        ÎßàÏù¥ÌéòÏù¥ÏßÄ | Moeim
    </title>
    <!-- ÎßàÏù¥ÌéòÏù¥ÏßÄ Ï†ÑÏö© CSS -->
    <link rel="stylesheet" th:href="@{/css/user/mypage.css}">
</head>

<body>
<th:block layout:fragment="content">

    <main class="mypage-wrapper">
        <section class="mypage-container">
            <!-- Ï¢åÏ∏° ÌîÑÎ°úÌïÑ Ïπ¥Îìú -->
            <aside class="profile-card">
                <div class="profile-header">
                    <div class="avatar">
                        <!-- DBÏóê Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏùÑ Îïå -->
                        <img th:if="${user != null and user.profileImage != null}"
                             th:src="@{/user/profile-image/{id}(id=${user.id})}"
                             alt="ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ"/>

                        <!-- ÏóÜÏùÑ Îïå Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ -->
                        <img th:if="${user == null or user.profileImage == null}"
                             th:src="@{/images/defaultProfilePicture.png}"
                             alt="Í∏∞Î≥∏ ÌîÑÎ°úÌïÑ Ïù¥ÎØ∏ÏßÄ"/>
                    </div>
                    <div class="profile-basic">
                        <h2 class="nickname"
                            th:text="${user != null && user.nickname != null ? user.nickname : 'ÎãâÎÑ§ÏûÑ'}">
                            ÎãâÎÑ§ÏûÑ
                        </h2>
                        <p class="email"
                           th:text="${user != null && user.email != null ? user.email : 'email@example.com'}">
                            email@example.com
                        </p>
                    </div>
                </div>

                <div class="profile-meta">
                    <div class="meta-item">
                        <span class="meta-label">Ï∞∏Ïó¨ Ï§ëÏù∏ Î™®ÏûÑ</span>
                        <span class="meta-value"
                              th:text="${joinedGroupCount} ?: 0">
                            0
                        </span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label"
                              th:text="${isOwner} ? 'ÎÇ¥ Í≤åÏãúÍ∏Ä' : 'ÏûëÏÑ±Ìïú Í≤åÏãúÍ∏Ä'">
                            ÎÇ¥ Í≤åÏãúÍ∏Ä
                        </span>
                        <span class="meta-value"
                              th:text="${postCount} ?: 0">
                            0
                        </span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label"
                              th:text="${isOwner} ? 'ÎÇ¥ ÎåìÍ∏Ä' : 'ÏûëÏÑ±Ìïú ÎåìÍ∏Ä'">
                            ÎÇ¥ ÎåìÍ∏Ä
                        </span>
                        <span class="meta-value"
                              th:text="${commentCount} ?: 0">
                            0
                        </span>
                    </div>

                    <div class="profile-interests" th:if="${userInterests != null and !userInterests.isEmpty()}">
                        <span class="interests-title">Í¥ÄÏã¨ÏÇ¨</span>
                        <div class="interest-chips">
                            <span class="interest-chip" th:each="cat : ${userInterests}"
                                  th:text="${cat.title}">Ïö¥Îèô</span>
                        </div>
                    </div>

                    <div class="profile-interests" th:if="${userInterests == null or userInterests.isEmpty()}">
                        <span class="interests-title">Í¥ÄÏã¨ÏÇ¨</span>
                        <span style="font-size: 12px; color: #999;">Îì±Î°ùÎêú Í¥ÄÏã¨ÏÇ¨Í∞Ä ÏóÜÏäµÎãàÎã§.</span>
                    </div>
                </div>

                <!-- Î≥∏Ïù∏Ïùº Îïå: ÌîÑÎ°úÌïÑ ÏàòÏ†ï Î≤ÑÌäº -->
                <div th:if="${loginUser != null and loginUser.id == myPageUser.id}">
                    <a th:href="@{/user/edit}" style="text-decoration:none;">
                        <button class="btn-edit-profile" type="button">
                            ÌîÑÎ°úÌïÑ ÏàòÏ†ï
                        </button>
                    </a>
                </div>

                <!--  Îã§Î•∏ ÏÇ¨ÎûåÏùº Îïå: Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞ Î≤ÑÌäº -->
                <div th:if="${!isOwner}">
                    <button class="btn-edit-profile"
                            type="button"
                            th:onclick="|openDirectChat(${user.id})|">
                        Î©îÏãúÏßÄ Î≥¥ÎÇ¥Í∏∞
                    </button>
                </div>

            </aside>

            <!-- Ïö∞Ï∏° ÎÇ¥Ïö© ÏòÅÏó≠ -->
            <section class="mypage-content">

                <!-- ÎÇ¥ Ï†ïÎ≥¥ Ïπ¥Îìú (ÏÉÅÎã® Ï†ÑÏ≤¥ Ìè≠) -->
                <div class="info-card">
                    <div class="info-card-header">
                        <!-- ÎÇ¥ ÌéòÏù¥ÏßÄÏùº Îïå -->
                        <h3 th:if="${isOwner}">ÎÇ¥ Ï†ïÎ≥¥</h3>

                        <!-- Îã§Î•∏ ÏÇ¨Îûå ÌéòÏù¥ÏßÄÏùº Îïå -->
                        <h3 th:if="${!isOwner}"
                            th:text="${user != null && user.nickname != null ? user.nickname + 'ÎãòÏùò Ï†ïÎ≥¥' : 'ÌöåÏõê Ï†ïÎ≥¥'}">
                            ÌöåÏõê Ï†ïÎ≥¥
                        </h3>
                    </div>
                    <div class="info-body">
                        <div class="info-row">
                            <span class="info-label">Ïù¥Î¶Ñ</span>
                            <span class="info-value"
                                  th:text="${user != null && user.nickname != null ? user.nickname : 'ÌôçÍ∏∏Îèô'}">
                                ÌôçÍ∏∏Îèô
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">ÎãâÎÑ§ÏûÑ</span>
                            <span class="info-value"
                                  th:text="${user != null && user.nickname != null ? user.nickname : 'ÎãâÎÑ§ÏûÑ'}">
                                ÎãâÎÑ§ÏûÑ
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ïù¥Î©îÏùº</span>
                            <span class="info-value"
                                  th:text="${user != null && user.email != null ? user.email : 'email@example.com'}">
                                email@example.com
                            </span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Í∞ÄÏûÖÏùº</span>
                            <span class="info-value"
                                  th:text="${user != null && user.createdAt != null ? #temporals.format(user.createdAt, 'yyyy.MM.dd') : '2025.01.01'}">
                                2025.01.01
                            </span>
                        </div>
                    </div>
                </div>

                <!-- ÏïÑÎûò 2√ó2 Í∑∏Î¶¨Îìú: Ï∞∏Ïó¨ Î™®ÏûÑ / ÎÇ¥ ÏùºÏ†ï / ÎÇ¥ Í≤åÏãúÍ∏Ä / ÎÇ¥ ÎåìÍ∏Ä -->
                <div class="grid-two">

                    <!-- Ï∞∏Ïó¨ Ï§ëÏù∏ Î™®ÏûÑ (Ï¢åÏÉÅÎã®) -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <h3>Ï∞∏Ïó¨ Ï§ëÏù∏ Î™®ÏûÑ</h3>
                            <a th:href="@{|/user/grouplist/${user.id}|}" class="link-small">Ï†ÑÏ≤¥ Î™®ÏûÑ Î≥¥Í∏∞</a>
                        </div>
                        <div class="info-body">
                            <ul class="group-list">
                                <!-- joinedGroups: List<GroupUser> -->
                                <li class="group-item" th:each="gu : ${joinedGroups}">
                                    <div class="group-main">
                                        <div class="group-title"
                                             th:text="${gu.group != null ? gu.group.title : 'Î™®ÏûÑ Ïù¥Î¶Ñ'}">
                                            Î™®ÏûÑ Ïù¥Î¶Ñ
                                        </div>
                                        <div class="group-meta">
                                            <span th:text="${gu.group != null && gu.group.category != null ? gu.group.category.title : 'Ïπ¥ÌÖåÍ≥†Î¶¨'}">
                                                Ïπ¥ÌÖåÍ≥†Î¶¨
                                            </span>
                                            <span> ¬∑ </span>
                                            <span th:text="${gu.createdAt != null ? #temporals.format(gu.createdAt, 'yyyy.MM.dd') : '2025.01.01'}">
                                                2025.01.01
                                            </span>
                                        </div>
                                    </div>
                                    <div class="group-actions">
                                        <a class="btn-outline"
                                           th:if="${isOwner}"
                                           th:href="@{/group/home/{id}(id=${gu.group.id})}">
                                            Î™®ÏûÑ ÌéòÏù¥ÏßÄÎ°ú
                                        </a>
                                    </div>
                                </li>

                                <li class="activity-item empty"
                                    th:if="${joinedGroups == null or #lists.isEmpty(joinedGroups)}">
                                    Ï∞∏Ïó¨ Ï§ëÏù∏ Î™®ÏûÑÏù¥ ÏóÜÏäµÎãàÎã§.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- ÎÇ¥ ÏùºÏ†ï (Ïö∞ÏÉÅÎã®, Îã¨Î†• Î∞ïÏä§) -->
                    <div class="info-card">
                        <div class="info-card-header"
                             style="display: flex; justify-content: space-between; align-items: center;">
                            <h3 th:if="${isOwner}">ÎÇ¥ ÏùºÏ†ï</h3>
                            <h3 th:if="${!isOwner}"
                                th:text="${user != null && user.nickname != null ? user.nickname + 'ÎãòÏùò ÏùºÏ†ï' : 'ÏùºÏ†ï'}">
                                ÏùºÏ†ï
                            </h3>

                            <button type="button"
                                    onclick="location.href='/schedule/my/export'"
                                    style="background-color: white; border: 1px solid #134D38; color: #134D38; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px; transition: 0.2s;">
                                <span>üì•</span>
                                <span th:text="${isOwner} ? 'ÎÇ¥ ÏùºÏ†ï ÎÇ¥Î≥¥ÎÇ¥Í∏∞' : 'ÏùºÏ†ï ÎÇ¥Î≥¥ÎÇ¥Í∏∞'">
                                    ÎÇ¥ ÏùºÏ†ï ÎÇ¥Î≥¥ÎÇ¥Í∏∞
                                </span>
                            </button>
                        </div>
                        <div class="info-body" style="padding: 0;">
                            <!--
                               apiUrl: '/api/schedule/mine' (ÎÇ¥ ÏùºÏ†ï API)
                               canAdd: false (ÎßàÏù¥ÌéòÏù¥ÏßÄÏóêÏÑúÎäî ÏùºÏ†ïÏ∂îÍ∞Ä ÏóÜÏùå)
                            -->
                            <div th:if="${isOwner}"
                                 th:replace="~{schedule/calendar_fragment :: calendarFragment(apiUrl='/api/schedule/mine', canAdd=false)}">
                            </div>

                            <div th:if="${!isOwner}"
                                 th:replace="~{schedule/calendar_fragment :: calendarFragment(apiUrl=${'/api/schedule/user/' + user.id}, canAdd=false)}">
                            </div>
                        </div>
                    </div>

                    <!-- ÎÇ¥Í∞Ä Ïì¥ Í≤åÏãúÍ∏Ä (Ï¢åÌïòÎã®) -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <!-- Ï†úÎ™© -->
                            <h3 th:if="${isOwner}">ÎÇ¥ Í≤åÏãúÍ∏Ä</h3>
                            <h3 th:if="${!isOwner}"
                                th:text="${user != null && user.nickname != null ? user.nickname + 'ÎãòÏùò Í≤åÏãúÍ∏Ä' : 'Í≤åÏãúÍ∏Ä'}">
                                Í≤åÏãúÍ∏Ä
                            </h3>
                            <a th:href="@{|/user/postlist/${user.id}|}"
                               class="link-small"
                               th:text="${isOwner} ? 'ÎÇ¥ Í∏Ä Î™®ÏïÑÎ≥¥Í∏∞' : 'Í∏Ä Î™®ÏïÑÎ≥¥Í∏∞'">
                                ÎÇ¥ Í∏Ä Î™®ÏïÑÎ≥¥Í∏∞
                            </a>
                        </div>
                        <div class="info-body">
                            <ul class="activity-list">
                                <!-- myPosts: List<Post> -->
                                <li class="activity-item" th:each="p : ${myPosts}">
                                    <div class="activity-main">
                                        <span class="activity-type">Í≤åÏãúÍ∏Ä</span>
                                        <a class="activity-title"
                                           th:href="@{/post/{category}/{id}(category=${p.category.id}, id=${p.id})}"
                                           th:text="${p.title}">
                                            Í≤åÏãúÍ∏Ä Ï†úÎ™©
                                        </a>
                                    </div>
                                    <div class="activity-meta">
                                        <span th:text="${p.createdAt != null ? #temporals.format(p.createdAt, 'yyyy.MM.dd HH:mm') : '2025.01.01 12:00'}">
                                            2025.01.01 12:00
                                        </span>
                                        <span th:if="${p.category != null}">
                                            ¬∑ <span th:text="${p.category.title}">Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö</span>
                                        </span>
                                    </div>
                                    <div class="activity-actions">
                                        <a class="btn-outline"
                                           th:href="@{/post/{category}/{id}(category=${p.category.id}, id=${p.id})}">
                                            Í≤åÏãúÍ∏Ä Î≥¥Í∏∞
                                        </a>
                                    </div>
                                </li>

                                <li class="activity-item empty"
                                    th:if="${myPosts == null or #lists.isEmpty(myPosts)}">
                                    ÏûëÏÑ±Ìïú Í≤åÏãúÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- ÎÇ¥Í∞Ä Ïì¥ ÎåìÍ∏Ä (Ïö∞ÌïòÎã®) -->
                    <div class="info-card">
                        <div class="info-card-header">
                            <h3 th:if="${isOwner}">ÎÇ¥ ÎåìÍ∏Ä</h3>
                            <h3 th:if="${!isOwner}"
                                th:text="${user != null && user.nickname != null ? user.nickname + 'ÎãòÏùò ÎåìÍ∏Ä' : 'ÎåìÍ∏Ä'}">
                                ÎåìÍ∏Ä
                            </h3>
                            <a th:href="@{|/user/commentlist/${user.id}|}"
                               class="link-small"
                               th:text="${isOwner} ? 'ÎÇ¥ ÎåìÍ∏Ä Î™®ÏïÑÎ≥¥Í∏∞' : 'ÎåìÍ∏Ä Î™®ÏïÑÎ≥¥Í∏∞'">
                                ÎåìÍ∏Ä Î™®ÏïÑÎ≥¥Í∏∞
                            </a>
                        </div>
                        <div class="info-body">
                            <ul class="activity-list">
                                <!-- myComments: List<Comment> -->
                                <li class="activity-item" th:each="c : ${myComments}">
                                    <div class="activity-main">
                                        <span class="activity-type">ÎåìÍ∏Ä</span>
                                        <a class="activity-title"
                                           th:href="@{/post/{category}/{id}(category=${c.post.category.id}, id=${c.post.id})}"
                                           th:text="${c.text}">
                                            ÎåìÍ∏Ä ÎÇ¥Ïö©ÏûÖÎãàÎã§...
                                        </a>
                                    </div>
                                    <div class="activity-meta">
                                        <span th:text="${c.createdAt != null ? #temporals.format(c.createdAt, 'yyyy.MM.dd HH:mm') : '2025.01.01 12:00'}">
                                            2025.01.01 12:00
                                        </span>
                                        <span th:if="${c.post != null}">
                                            ¬∑ <a class="link-small"
                                                 th:href="@{/post/{category}/{id}(category=${c.post.category.id}, id=${c.post.id})}"
                                                 th:text="${c.post.title}">
                                                ÏõêÍ∏Ä Ï†úÎ™©
                                            </a>
                                        </span>
                                    </div>
                                    <div class="activity-actions">
                                        <a class="btn-outline"
                                           th:href="@{/post/{category}/{id}(category=${c.post.category.id}, id=${c.post.id})}">
                                            Ìï¥Îãπ Í≤åÏãúÍ∏ÄÎ°ú
                                        </a>
                                    </div>
                                </li>

                                <li class="activity-item empty"
                                    th:if="${myComments == null or #lists.isEmpty(myComments)}">
                                    ÏûëÏÑ±Ìïú ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.
                                </li>
                            </ul>
                        </div>
                    </div>

                </div>
                <!-- TODO (Ï†ÅÎãπÌïú ÏúÑÏπòÏóê Ïû¨ÏÑ§Ï†ï) ÎÇ¥ ÌèâÏ†ê (Overall) -->
                <div class="info-card" style="margin-bottom: 40px;">

                    <div class="info-card-header">
                        <h3>
                            Î∞õÏùÄ ÌèâÍ∞Ä <span style="color:#0f6b4a;">([[${stats.reviewCount}]])</span>
                        </h3>
                        <a th:href="@{|/review/user/${user.id}/list|}" class="link-small">
                            Ï†ÑÏ≤¥ Î≥¥Í∏∞
                        </a>
                    </div>

                    <div class="info-body">

                        <div class="review-summary-container">

                            <div class="review-total-area">
                                <div class="total-score-num" th:text="${stats.averageTotal}">0.0</div>

                                <div class="star-rating-display" th:title="|ÌèâÏ†ê ${stats.averageTotal}Ï†ê|">
                                    <div class="star-base">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                                    <div class="star-fill"
                                         th:style="|width: ${(stats.averageTotal / 5.0) * 100}%|">
                                        ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
                                    </div>
                                </div>
                                <div class="total-score-label">Ï¢ÖÌï© ÌèâÏ†ê</div>
                            </div>

                            <div class="review-chart-area">

                                <div class="chart-item">
                                    <div class="bar-label">
                                        <span>Îß§ÎÑà/ÌÉúÎèÑ</span>
                                        <span th:text="${stats.averageManner}">0.0</span>
                                    </div>
                                    <div class="bar-bg">
                                        <div class="bar-fill"
                                             th:style="|width: ${stats.averageManner * 20}%|"></div>
                                    </div>
                                </div>

                                <div class="chart-item">
                                    <div class="bar-label">
                                        <span>Í∏∞Ïó¨ÎèÑ</span>
                                        <span th:text="${stats.averageContribution}">0.0</span>
                                    </div>
                                    <div class="bar-bg">
                                        <div class="bar-fill"
                                             th:style="|width: ${stats.averageContribution * 20}%|"></div>
                                    </div>
                                </div>

                                <div class="chart-item">
                                    <div class="bar-label">
                                        <span>ÏãúÍ∞Ñ ÏóÑÏàò</span>
                                        <span th:text="${stats.averagePunctuality}">0.0</span>
                                    </div>
                                    <div class="bar-bg">
                                        <div class="bar-fill"
                                             th:style="|width: ${stats.averagePunctuality * 20}%|"></div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </section>
        </section>
    </main>

</th:block>
</body>
</html>
